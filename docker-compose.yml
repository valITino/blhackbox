# blhackbox v2.0 — Modular Docker Infrastructure
#
# Usage:
#   docker compose up                       Start core stack (6 containers)
#   docker compose --profile neo4j up       Start with Neo4j (7 containers)
#   docker compose build                    Build all custom images locally
#
# Claude Desktop config:
#   {"mcpServers": {"blhackbox": {"transport": "sse", "url": "http://localhost:8080/sse"}}}

networks:
  blhackbox_net:
    driver: bridge
    name: blhackbox_net

volumes:
  neo4j_data:
  neo4j_logs:
  ollama_models:
  portainer_data:
  results:
  wordlists:

services:

  # ── MCP GATEWAY ─────────────────────────────────────────────────────
  # Single entry point for all MCP clients (Claude Desktop, Claude Code,
  # OpenAI). Routes tool calls to the correct MCP server container.
  # Docs: https://github.com/docker/mcp-gateway
  mcp-gateway:
    image: docker/mcp-gateway:latest
    container_name: blhackbox-mcp-gateway
    restart: unless-stopped
    ports:
      - "${MCP_GATEWAY_PORT:-8080}:8080"
    volumes:
      - ./blhackbox-mcp-catalog.yaml:/catalog.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      gateway run
      --catalog /catalog.yaml
      --port 8080
      --transport streaming
      --log-calls
      --block-secrets
    networks:
      - blhackbox_net
    depends_on:
      - kali-mcp
      - hexstrike
      - ollama-mcp

  # ── KALI MCP SERVER ─────────────────────────────────────────────────
  kali-mcp:
    build:
      context: .
      dockerfile: docker/kali-mcp.Dockerfile
    container_name: blhackbox-kali-mcp
    restart: unless-stopped
    privileged: true
    networks:
      - blhackbox_net

  # ── HEXSTRIKE MCP SERVER ────────────────────────────────────────────
  # Source: https://github.com/0x4m4/hexstrike-ai
  hexstrike:
    build:
      context: .
      dockerfile: docker/hexstrike.Dockerfile
    container_name: blhackbox-hexstrike
    restart: unless-stopped
    ports:
      - "8888:8888"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - blhackbox_net

  # ── OLLAMA MCP SERVER (CUSTOM) ──────────────────────────────────────
  # blhackbox custom component. NOT an official Ollama product.
  # Runs 3 agents (Ingestion, Processing, Synthesis) that call the
  # Ollama container's /api/chat endpoint with task-specific prompts.
  ollama-mcp:
    build:
      context: .
      dockerfile: docker/ollama-mcp.Dockerfile
    container_name: blhackbox-ollama-mcp
    restart: unless-stopped
    environment:
      OLLAMA_URL: "http://ollama:11434"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-llama3.3}"
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-}"
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - blhackbox_net

  # ── OLLAMA ──────────────────────────────────────────────────────────
  # Standard Ollama image — zero custom configuration.
  ollama:
    image: ollama/ollama:latest
    container_name: blhackbox-ollama
    restart: unless-stopped
    volumes:
      - ollama_models:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - blhackbox_net
    # GPU support — uncomment if NVIDIA GPU available:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # ── NEO4J (OPTIONAL) ────────────────────────────────────────────────
  # Enable with: docker compose --profile neo4j up
  # Provides cross-session persistence and relationship querying.
  # Not needed for single-engagement use.
  neo4j:
    image: neo4j:5
    container_name: blhackbox-neo4j
    profiles: ["neo4j"]
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD}"
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: "512m"
      NEO4J_dbms_memory_heap_max__size: "1G"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - blhackbox_net

  # ── PORTAINER CE ────────────────────────────────────────────────────
  # Web UI for container management — https://localhost:9443
  # Source: https://github.com/portainer/portainer
  # WARNING: mounts Docker socket — grants effective root on host.
  # Never expose port 9443 to the public internet.
  portainer:
    image: portainer/portainer-ce:latest
    container_name: blhackbox-portainer
    restart: always
    ports:
      - "9443:9443"
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - blhackbox_net
