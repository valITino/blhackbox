services:
  # -------------------------------------------------------
  # HexStrike AI MCP Server – the execution engine
  # -------------------------------------------------------
  hexstrike:
    build:
      context: ./hexstrike
      dockerfile: Dockerfile
    container_name: hexstrike
    ports:
      - "127.0.0.1:8888:8888"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - hexstrike_data:/app/data
    networks:
      - blhackbox-net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # -------------------------------------------------------
  # Neo4j – knowledge graph for attack surface modeling
  # -------------------------------------------------------
  neo4j:
    image: neo4j:5-community
    container_name: blhackbox-neo4j
    ports:
      - "127.0.0.1:7474:7474"   # HTTP browser – localhost only
      - "127.0.0.1:7687:7687"   # Bolt protocol – localhost only
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set in .env}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - blhackbox-net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER:-neo4j}", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # -------------------------------------------------------
  # Blhackbox – the intelligence layer
  # -------------------------------------------------------
  blhackbox:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blhackbox
    depends_on:
      hexstrike:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      - HEXSTRIKE_URL=${HEXSTRIKE_URL:-http://hexstrike:8888}
      - HEXSTRIKE_TIMEOUT=${HEXSTRIKE_TIMEOUT:-120}
      - HEXSTRIKE_MAX_RETRIES=${HEXSTRIKE_MAX_RETRIES:-3}
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set in .env}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
      - LLM_PROVIDER_PRIORITY=${LLM_PROVIDER_PRIORITY:-openai,anthropic,ollama}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RESULTS_DIR=/app/results
      - WORDLISTS_DIR=/app/wordlists
    volumes:
      - ./blhackbox:/app/blhackbox   # live-reload for development
      - ./results:/app/results
      - ./wordlists:/app/wordlists:ro
    tmpfs:
      - /tmp:noexec,nosuid,size=256m
    networks:
      - blhackbox-net
    restart: "no"
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
    # Keep container alive for interactive use
    entrypoint: ["tail", "-f", "/dev/null"]

  # -------------------------------------------------------
  # Ollama – local LLM (optional, for offline use)
  # -------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: blhackbox-ollama
    ports:
      - "127.0.0.1:11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - blhackbox-net
    profiles:
      - ollama   # Only start with: docker compose --profile ollama up
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: "4.0"

volumes:
  hexstrike_data:
  neo4j_data:
  neo4j_logs:
  ollama_data:

networks:
  blhackbox-net:
    driver: bridge
