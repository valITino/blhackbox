# blhackbox v2.0 -- Modular Docker Infrastructure
#
# Usage:
#   docker compose pull                          Pull all pre-built images
#   docker compose up -d                         Start core stack (8 containers)
#   docker compose --profile gateway up -d       Start with MCP Gateway (9 containers)
#   docker compose --profile claude-code up -d   Start with Claude Code container
#   docker compose --profile neo4j up -d         Start with Neo4j
#   docker compose build                         Build all custom images locally
#
# Claude Code (Docker) connects DIRECTLY to each MCP server via SSE.
# Claude Desktop / ChatGPT connect via the MCP Gateway (--profile gateway).
#
# Claude Desktop config (requires --profile gateway):
#   {"mcpServers": {"blhackbox": {"transport": "streamable-http", "url": "http://localhost:8080/mcp"}}}

networks:
  blhackbox_net:
    driver: bridge
    name: blhackbox_net

volumes:
  neo4j_data:
  neo4j_logs:
  ollama_models:
  portainer_data:
  results:
  wordlists:

services:

  # -- MCP GATEWAY (OPTIONAL) ------------------------------------------------
  # Single entry point for HOST-based MCP clients (Claude Desktop, ChatGPT).
  # NOT needed for Claude Code in Docker â€” it connects directly to each server.
  # Enable with: docker compose --profile gateway up -d
  #
  # The gateway requires Docker socket access for initialization. It proxies
  # tool calls from localhost:8080/mcp to the correct MCP server container.
  # Docs: https://github.com/docker/mcp-gateway
  mcp-gateway:
    image: docker/mcp-gateway:latest
    container_name: blhackbox-mcp-gateway
    profiles: ["gateway"]
    restart: unless-stopped
    ports:
      - "${MCP_GATEWAY_PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./blhackbox-mcp-catalog.yaml:/catalog.yaml:ro
    environment:
      HOME: /root
      # Use .env file for secrets instead of Docker Desktop secrets store.
      # This is required on headless Linux without Docker Desktop.
      DOCKER_MCP_IN_CONTAINER: "1"
    command:
      - --transport=streaming
      - --port=8080
      - --catalog=/catalog.yaml
      - --servers=kali
      - --servers=hexstrike
      - --servers=ollama-mcp
      - --secrets=./.env
    networks:
      - blhackbox_net
    depends_on:
      kali-mcp:
        condition: service_healthy
      hexstrike:
        condition: service_healthy
      ollama-mcp:
        condition: service_healthy

  # -- KALI MCP SERVER -------------------------------------------------------
  kali-mcp:
    image: crhacky/blhackbox:kali-mcp
    build:
      context: .
      dockerfile: docker/kali-mcp.Dockerfile
    container_name: blhackbox-kali-mcp
    restart: unless-stopped
    privileged: true
    init: true
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:9001/sse')\""]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - blhackbox_net

  # -- HEXSTRIKE MCP SERVER --------------------------------------------------
  # Source: https://github.com/0x4m4/hexstrike-ai
  hexstrike:
    image: crhacky/blhackbox:hexstrike
    build:
      context: .
      dockerfile: docker/hexstrike.Dockerfile
    container_name: blhackbox-hexstrike
    restart: unless-stopped
    init: true
    ports:
      - "8888:8888"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8888/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - blhackbox_net

  # -- OLLAMA MCP SERVER (CUSTOM) --------------------------------------------
  # blhackbox custom component. NOT an official Ollama product.
  # Thin MCP orchestrator -- calls the 3 agent containers in sequence
  # via HTTP, assembles the AggregatedPayload, and returns it to Claude.
  # Does NOT call Ollama directly.
  ollama-mcp:
    image: crhacky/blhackbox:ollama-mcp
    build:
      context: .
      dockerfile: docker/ollama-mcp.Dockerfile
    container_name: blhackbox-ollama-mcp
    restart: unless-stopped
    init: true
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:9000/sse')\""]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s
    environment:
      OLLAMA_URL: "http://ollama:11434"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-llama3.3}"
      AGENT_INGESTION_URL: "http://agent-ingestion:8001"
      AGENT_PROCESSING_URL: "http://agent-processing:8002"
      AGENT_SYNTHESIS_URL: "http://agent-synthesis:8003"
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-}"
    depends_on:
      agent-ingestion:
        condition: service_healthy
      agent-processing:
        condition: service_healthy
      agent-synthesis:
        condition: service_healthy
    networks:
      - blhackbox_net

  # -- AGENT 1: INGESTION ---------------------------------------------------
  # Parses and structures raw Kali + HexStrike tool output.
  # Calls Ollama /api/chat with ingestion system prompt.
  agent-ingestion:
    image: crhacky/blhackbox:agent-ingestion
    build:
      context: .
      dockerfile: docker/agent-ingestion.Dockerfile
    container_name: blhackbox-agent-ingestion
    restart: unless-stopped
    environment:
      OLLAMA_URL: "http://ollama:11434"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-llama3.3}"
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8001/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - blhackbox_net

  # -- AGENT 2: PROCESSING --------------------------------------------------
  # Deduplicates, extracts errors, compresses data into efficient blobs.
  # Annotates error_log entries with security_relevance.
  agent-processing:
    image: crhacky/blhackbox:agent-processing
    build:
      context: .
      dockerfile: docker/agent-processing.Dockerfile
    container_name: blhackbox-agent-processing
    restart: unless-stopped
    environment:
      OLLAMA_URL: "http://ollama:11434"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-llama3.3}"
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8002/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - blhackbox_net

  # -- AGENT 3: SYNTHESIS ----------------------------------------------------
  # Merges Agent 1 + Agent 2 output into final AggregatedPayload.
  # Adds metadata, resolves conflicts, sends back to Claude.
  agent-synthesis:
    image: crhacky/blhackbox:agent-synthesis
    build:
      context: .
      dockerfile: docker/agent-synthesis.Dockerfile
    container_name: blhackbox-agent-synthesis
    restart: unless-stopped
    environment:
      OLLAMA_URL: "http://ollama:11434"
      OLLAMA_MODEL: "${OLLAMA_MODEL:-llama3.3}"
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8003/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - blhackbox_net

  # -- OLLAMA ----------------------------------------------------------------
  # Standard Ollama image -- zero custom configuration.
  # All 3 agent containers call this via /api/chat independently.
  ollama:
    image: ollama/ollama:latest
    container_name: blhackbox-ollama
    restart: unless-stopped
    volumes:
      - ollama_models:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - blhackbox_net
    # GPU support -- enabled by default for NVIDIA GPUs.
    # If you do NOT have an NVIDIA GPU, comment out the 'deploy' block below.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # -- NEO4J (OPTIONAL) ------------------------------------------------------
  # Enable with: docker compose --profile neo4j up -d
  # Provides cross-session persistence and relationship querying.
  # Not needed for single-engagement use.
  neo4j:
    image: neo4j:5
    container_name: blhackbox-neo4j
    profiles: ["neo4j"]
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD}"
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: "512m"
      NEO4J_dbms_memory_heap_max__size: "1G"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "neo4j", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - blhackbox_net

  # -- CLAUDE CODE (OPTIONAL) ------------------------------------------------
  # MCP client running inside Docker -- no host install needed.
  # Enable with: docker compose --profile claude-code up -d
  # Then run:    docker compose run --rm claude-code
  #
  # Connects DIRECTLY to each MCP server via SSE over the Docker network.
  # Does NOT require the MCP Gateway.
  claude-code:
    image: crhacky/blhackbox:claude-code
    build:
      context: .
      dockerfile: docker/claude-code.Dockerfile
    container_name: blhackbox-claude-code
    profiles: ["claude-code"]
    stdin_open: true
    tty: true
    environment:
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      # Bypass egress proxies (e.g. GitHub Codespaces) for internal Docker traffic
      no_proxy: "mcp-gateway,kali-mcp,hexstrike,ollama-mcp,ollama,agent-ingestion,agent-processing,agent-synthesis,localhost,127.0.0.1"
      NO_PROXY: "mcp-gateway,kali-mcp,hexstrike,ollama-mcp,ollama,agent-ingestion,agent-processing,agent-synthesis,localhost,127.0.0.1"
    depends_on:
      kali-mcp:
        condition: service_healthy
      hexstrike:
        condition: service_healthy
      ollama-mcp:
        condition: service_healthy
    networks:
      - blhackbox_net

  # -- PORTAINER CE ----------------------------------------------------------
  # Web UI for container management -- https://localhost:9443
  # Source: https://github.com/portainer/portainer
  #
  # FIRST RUN: Open https://localhost:9443 and create an admin account
  # within 5 minutes of startup. If you miss the window, restart Portainer:
  #   docker compose restart portainer
  #
  # WARNING: mounts Docker socket -- grants effective root on host.
  # Never expose port 9443 to the public internet.
  portainer:
    image: portainer/portainer-ce:latest
    container_name: blhackbox-portainer
    restart: always
    ports:
      - "9443:9443"
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - blhackbox_net
