"""Tests for the exploit guidance feature."""

from __future__ import annotations

import json

from click.testing import CliRunner

from blhackbox.core.exploit_generator import _parse_guidance_response
from blhackbox.llm.exploit_prompts import (
    SYSTEM_PROMPT_EXPLOIT,
    SYSTEM_PROMPT_EXPLOIT_NO_POC,
    build_exploit_user_prompt,
)
from blhackbox.main import cli

# ---------------------------------------------------------------------------
# Prompt tests
# ---------------------------------------------------------------------------


class TestExploitPrompts:
    def test_no_poc_prompt_forbids_exploit_code(self) -> None:
        assert "NEVER produce exploit code" in SYSTEM_PROMPT_EXPLOIT_NO_POC
        assert "proof-of-concept steps" in SYSTEM_PROMPT_EXPLOIT_NO_POC

    def test_poc_prompt_has_guardrails(self) -> None:
        assert "NEVER produce weaponised exploit code" in SYSTEM_PROMPT_EXPLOIT
        assert "No shell commands" in SYSTEM_PROMPT_EXPLOIT
        assert "remediation" in SYSTEM_PROMPT_EXPLOIT.lower()

    def test_both_prompts_require_authorization(self) -> None:
        for prompt in (SYSTEM_PROMPT_EXPLOIT, SYSTEM_PROMPT_EXPLOIT_NO_POC):
            assert "AUTHORIZED" in prompt
            assert "NEVER" in prompt

    def test_build_user_prompt_no_poc(self) -> None:
        prompt = build_exploit_user_prompt('[]', allow_poc=False)
        assert "No" in prompt
        assert "[]" in prompt

    def test_build_user_prompt_with_poc(self) -> None:
        prompt = build_exploit_user_prompt('[]', allow_poc=True)
        assert "Yes" in prompt


# ---------------------------------------------------------------------------
# Response parser tests
# ---------------------------------------------------------------------------


class TestParseGuidanceResponse:
    def test_valid_json_array(self) -> None:
        raw = json.dumps([
            {
                "finding_id": "abc123",
                "title": "SQL Injection",
                "exploitability": "confirmed",
                "description": "User input is passed to query",
                "proof_of_concept": None,
                "impact": "Full database access",
                "remediation": "Use parameterized queries",
            }
        ])
        result = _parse_guidance_response(raw)
        assert len(result) == 1
        assert result[0]["finding_id"] == "abc123"

    def test_markdown_fenced_json(self) -> None:
        inner = json.dumps([
            {
                "finding_id": "x",
                "title": "XSS",
                "exploitability": "likely",
                "description": "Reflected input",
                "proof_of_concept": None,
                "impact": "Session hijacking",
                "remediation": "Escape output",
            }
        ])
        raw = f"```json\n{inner}\n```"
        result = _parse_guidance_response(raw)
        assert len(result) == 1

    def test_invalid_json_returns_empty(self) -> None:
        result = _parse_guidance_response("not json at all")
        assert result == []

    def test_missing_required_keys_skipped(self) -> None:
        raw = json.dumps([
            {"finding_id": "a", "title": "incomplete"},
            {
                "finding_id": "b",
                "title": "complete",
                "exploitability": "theoretical",
                "description": "desc",
                "proof_of_concept": None,
                "impact": "impact",
                "remediation": "fix it",
            },
        ])
        result = _parse_guidance_response(raw)
        assert len(result) == 1
        assert result[0]["finding_id"] == "b"

    def test_non_array_returns_empty(self) -> None:
        result = _parse_guidance_response('{"not": "an array"}')
        assert result == []


# ---------------------------------------------------------------------------
# CLI tests
# ---------------------------------------------------------------------------


class TestExploitCLI:
    def test_exploit_without_authorized(self) -> None:
        runner = CliRunner()
        result = runner.invoke(
            cli,
            ["exploit", "--session", "fake_session"],
        )
        assert result.exit_code != 0
        assert "authorized" in result.output.lower()

    def test_exploit_with_authorized_bad_session(self) -> None:
        runner = CliRunner()
        result = runner.invoke(
            cli,
            ["exploit", "--session", "nonexistent_session_xyz", "--authorized"],
        )
        assert result.exit_code != 0

    def test_exploit_help(self) -> None:
        runner = CliRunner()
        result = runner.invoke(cli, ["exploit", "--help"])
        assert result.exit_code == 0
        assert "--authorized" in result.output
        assert "--allow-poc" in result.output
